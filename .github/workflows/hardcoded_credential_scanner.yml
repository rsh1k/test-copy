name: Scheduled dotCMS Credential Scan

on:
  schedule:
    - cron: '0 0 * * *' # Run daily at midnight UTC
  workflow_dispatch: # Allow manual trigger

jobs:
  scan_latest_dotcms_release:
    runs-on: ubuntu-latest
    
    env:
      TARGET_REPO: dotcms/core
      DETECTOR_REPO: ynori7/credential-detector
      SCAN_DIR: dotcms_source
      LAST_SCANNED_TAG_FILE: last_scanned_tag.txt
    
    steps:
      # Install jq for JSON parsing
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      # Check out the workflow repository (to store state, e.g., last scanned tag)
      - name: Checkout Workflow Repository
        uses: actions/checkout@v4

      # Get the latest dotCMS release tag
      - name: Get Latest Tag
        id: get_tag
        run: |
          LATEST_TAG=$(curl -s -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/${{ env.TARGET_REPO }}/releases/latest" | jq -r .tag_name)
          
          if [ -z "$LATEST_TAG" ]; then
            echo "::error::Could not find latest release tag for ${{ env.TARGET_REPO }}. Skipping scan."
            exit 1
          fi
          
          echo "Latest dotCMS tag is: $LATEST_TAG"
          echo "tag=$LATEST_TAG" >> $GITHUB_OUTPUT

      # Check if the tag has changed since the last scan
      - name: Check if Tag Changed
        id: check_tag
        run: |
          if [ -f "${{ env.LAST_SCANNED_TAG_FILE }}" ]; then
            LAST_SCANNED_TAG=$(cat ${{ env.LAST_SCANNED_TAG_FILE }})
            if [ "$LAST_SCANNED_TAG" = "${{ steps.get_tag.outputs.tag }}" ] && [ "${{ github.event_name }}" != "workflow_dispatch" ]; then
              echo "No new release detected. Last scanned tag: $LAST_SCANNED_TAG. Skipping scan."
              echo "skip_scan=true" >> $GITHUB_OUTPUT
            else
              echo "New release detected or manual trigger. Proceeding with scan."
              echo "skip_scan=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "No previous tag found. Proceeding with scan."
            echo "skip_scan=false" >> $GITHUB_OUTPUT
          fi

      # Set up Go environment
      - name: Setup Go Environment
        if: steps.check_tag.outputs.skip_scan != 'true'
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # Use a stable Go version compatible with credential-detector

      # Cache Go modules
      - name: Cache Go Modules
        if: steps.check_tag.outputs.skip_scan != 'true'
        uses: actions/cache@v4
        with:
          path: |
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-go-

      # Checkout credential-detector repository
      - name: Checkout Credential Detector
        if: steps.check_tag.outputs.skip_scan != 'true'
        uses: actions/checkout@v4
        with:
          repository: ${{ env.DETECTOR_REPO }}
          path: credential-detector

      # Install credential-detector
      - name: Install Credential Detector
        if: steps.check_tag.outputs.skip_scan != 'true'
        run: |
          cd credential-detector
          go install

      # Clone the specific dotCMS version for scanning
      - name: Clone Target Repository Version
        if: steps.check_tag.outputs.skip_scan != 'true'
        run: |
          echo "Cloning ${{ env.TARGET_REPO }} at tag ${{ steps.get_tag.outputs.tag }}"
          if ! git clone --depth 1 --branch ${{ steps.get_tag.outputs.tag }} https://github.com/${{ env.TARGET_REPO }}.git ${{ env.SCAN_DIR }}; then
            echo "::error::Failed to clone ${{ env.TARGET_REPO }} at tag ${{ steps.get_tag.outputs.tag }}"
            exit 1
          fi

      # Run the credential scan
      - name: Run Credential Scan
        if: steps.check_tag.outputs.skip_scan != 'true'
        run: |
          echo "Starting scan of dotCMS version ${{ steps.get_tag.outputs.tag }}..."
          cd credential-detector
          if ! ~/go/bin/credential-detector --path "../${{ env.SCAN_DIR }}" --config config/default_config.yaml; then
            echo "::warning::Credential scan completed with potential findings. Check the output above for details."
            exit 0 # Don't fail the workflow, as findings are expected
          fi
          echo "No credentials found."

      # Save the scanned tag to avoid redundant scans
      - name: Save Scanned Tag
        if: steps.check_tag.outputs.skip_scan != 'true'
        run: |
          echo "${{ steps.get_tag.outputs.tag }}" > ${{ env.LAST_SCANNED_TAG_FILE }}
          git config --global user.name "github-actions"
          git config --global user.email "github-actions@github.com"
          git add ${{ env.LAST_SCANNED_TAG_FILE }}
          git commit -m "Update last scanned tag to ${{ steps.get_tag.outputs.tag }}"
          git push
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      # Optional: Notify on credential findings (e.g., create a GitHub Issue)
      - name: Notify on Credential Findings
        if: steps.check_tag.outputs.skip_scan != 'true' && failure()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: 'Potential Hardcoded Credentials Found in dotCMS ${{ steps.get_tag.outputs.tag }}',
              body: 'The credential scan for dotCMS version ${{ steps.get_tag.outputs.tag }} detected potential hardcoded credentials. Please review the workflow logs for details.'
            });
