name: End-to-End Vulnerability Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      target_repo_path:
        description: 'Path to the tool repo on the server'
        required: true
        default: '/home/rashik/vulnerability-analysis'
      config_filename:
        description: 'Name of the generated JSON config file'
        required: true
        default: 'input_analysis_config.json'

jobs:
  full-analysis-pipeline:
    runs-on: self-hosted
    permissions:
      contents: write
      
    env:
      NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
      GHSA_API_KEY: ${{ secrets.GHSA_API_KEY }}
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
      REPORT_DIR: "/home/rashik/vulnerability-analysis/.tmp/vulnerability_markdown_reports/vulnerability_reports_dotcms_latest"
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. Pre-Analysis Cleanup ---
      - name: Cleanup Previous Results
        run: |
          echo "Cleaning up old reports using Docker..."
          docker run --rm -v /home/rashik/vulnerability-analysis:/data alpine sh -c "rm -rf /data/.tmp/vulnerability_markdown_reports/vulnerability_reports_dotcms_latest/*"
          mkdir -p "$REPORT_DIR"

      # --- 2. Install Tools (Local Bin) ---
      - name: Install Syft and Trivy
        run: |
          mkdir -p "$GITHUB_WORKSPACE/bin"
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b "$GITHUB_WORKSPACE/bin"
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b "$GITHUB_WORKSPACE/bin"
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      # --- 3. Generate SBOM ---
      - name: Generate SBOM
        run: |
          SBOM_PATH="data/sboms/docker.io/dotcms/dotcms/dotcms:latest.sbom"
          mkdir -p "$(dirname "$SBOM_PATH")"
          syft scan dir:. -o syft-table > "$SBOM_PATH"

      # --- 4. Trivy Vulnerability Scan (Increased Timeout & Skips) ---
      - name: Run Trivy Scan
        run: |
          trivy fs . \
            --format json \
            --severity CRITICAL,HIGH \
            --output cve-report.json \
            --exit-code 0 \
            --timeout 15m \
            --skip-dirs "**/src/test" \
            --skip-files "core-web/documentation.json"

      # --- 5. Generate NVIDIA Config ---
      - name: Create JSON Config
        run: |
          cat << 'EOF' > update_json_input.py
          import json
          import os

          CONFIG_FILE = os.getenv('CONFIG_FILENAME', 'input_analysis_config.json')
          TRIVY_REPORT = 'cve-report.json'
          SBOM_PATH_REMOTE = "data/sboms/docker.io/dotcms/dotcms/dotcms:latest.sbom"

          BASE_JSON = {
              "image": {
                  "name": "docker.io/dotcms/dotcms", "tag": "latest",
                  "source_info": [
                      {"type": "code", "git_repo": "https://github.com/dotCMS/core.git", "ref": "main", "include": ["**/pom.xml", "core/src/main/java/**/*"], "exclude": ["**/target/**"]},
                      {"type": "doc", "git_repo": "https://github.com/dotCMS/core.git", "ref": "main", "include": ["README.md", "SECURITY.md"]}
                  ],
                  "sbom_info": { "_type": "file", "file_path": SBOM_PATH_REMOTE },
                  "dependency_files": ["**/pom.xml", "**/package.json"],
                  "build_system": "maven"
              },
              "scan": { "vulns": [] }
          }
          
          def extract_cve_ids(report_path):
              cve_ids = set()
              if not os.path.exists(report_path): return []
              with open(report_path, 'r') as f: report = json.load(f)
              for result in report.get('Results', []):
                  for vuln in result.get('Vulnerabilities', []):
                      cve_ids.add(vuln.get('VulnerabilityID'))
              return [{"vuln_id": cid} for cid in sorted(list(cve_ids)) if cid]

          BASE_JSON['scan']['vulns'] = extract_cve_ids(TRIVY_REPORT)
          with open(CONFIG_FILE, 'w') as f:
              json.dump(BASE_JSON, f, indent=2)
          EOF
          python3 update_json_input.py
        env:
          CONFIG_FILENAME: ${{ github.event.inputs.config_filename }}

      # --- 6. Run NVIDIA Scanner ---
      - name: Execute NVIDIA Analysis
        run: |
          cd ${{ github.event.inputs.target_repo_path }}
          echo "${{ env.NVIDIA_API_KEY }}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          
          docker compose run --rm \
            -e NVIDIA_API_KEY="${{ env.NVIDIA_API_KEY }}" \
            -e GHSA_API_KEY="${{ env.GHSA_API_KEY }}" \
            -e NVD_API_KEY="${{ env.NVD_API_KEY }}" \
            vuln-analysis nat run --config ${{ github.workspace }}/${{ github.event.inputs.config_filename }}

      # --- 7. Generate Table and Push ---
      - name: Process Results and Push to External Repo
        env:
          RESULTS_REPO: "https://x-access-token:${{ secrets.MY_PAT }}@github.com/rsh1k/test-copy.git"
        run: |
          sudo chown -R $USER:$USER "$REPORT_DIR"

          cat << 'EOF' > generate_summary.py
          import os
          import json
          import glob
          import datetime

          def generate():
              trivy_file = 'cve-report.json'
              source_dir = os.getenv('REPORT_DIR')
              
              trivy_data = {}
              if os.path.exists(trivy_file):
                  with open(trivy_file) as f:
                      data = json.load(f)
                      for res in data.get('Results', []):
                          for v in res.get('Vulnerabilities', []):
                              trivy_data[v['VulnerabilityID']] = v.get('Severity', 'UNKNOWN')

              report_md = f"# Scan Results: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}\n\n"
              report_md += "| CVE ID | Severity | NVIDIA Analysis | Report Link |\n"
              report_md += "| :--- | :--- | :--- | :--- |\n"

              md_files = glob.glob(f"{source_dir}/*.md")
              for filepath in sorted(md_files):
                  filename = os.path.basename(filepath)
                  if filename == "README.md": continue
                  cve_id = filename.replace('.md', '')
                  severity = trivy_data.get(cve_id, "N/A")
                  
                  analysis_status = "Pending review"
                  try:
                      with open(filepath, 'r') as f:
                          content = f.read().lower()
                          if "false positive" in content: analysis_status = "❌ False Positive"
                          elif "true positive" in content: analysis_status = "✅ True Positive"
                  except: pass

                  report_md += f"| {cve_id} | {severity} | {analysis_status} | [View File](./{filename}) |\n"

              with open(os.path.join(source_dir, "README.md"), "w") as f:
                  f.write(report_md)

          generate()
          EOF

          python3 generate_summary.py

          RUN_FOLDER="run-${{ github.run_number }}-${{ github.run_id }}"
          git clone $RESULTS_REPO results_repo
          mkdir -p "results_repo/$RUN_FOLDER"
          cp "$REPORT_DIR"/*.md "results_repo/$RUN_FOLDER/"
          
          cd results_repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Reports for run ${{ github.run_number }}"
          git push
