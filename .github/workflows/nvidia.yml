name: End-to-End Vulnerability Analysis Pipeline

on:
  workflow_dispatch:
    inputs:
      target_repo_path:
        description: 'Path to the tool repo on the server'
        required: true
        default: '/home/rashik/vulnerability-analysis'
      input_filename:
        description: 'Name of the generated JSON input file'
        required: true
        default: 'input.json'

jobs:
  full-analysis-pipeline:
    runs-on: self-hosted
    permissions:
      contents: write
      
    env:
      NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
      GHSA_API_KEY: ${{ secrets.GHSA_API_KEY }}
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
      TOOL_PATH: "/home/rashik/vulnerability-analysis"
      REPORT_DIR: "/home/rashik/vulnerability-analysis/.tmp/vulnerability_markdown_reports/vulnerability_reports_dotcms_latest"
      
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      # --- 1. Cleanup Previous Results ---
      - name: Cleanup Previous Results
        run: |
          echo "Cleaning up old reports..."
          docker run --rm -v ${{ env.TOOL_PATH }}:/data alpine sh -c "rm -rf /data/.tmp/vulnerability_markdown_reports/vulnerability_reports_dotcms_latest/*"
          mkdir -p "$REPORT_DIR"

      # --- 2. Install Tools (Syft & Trivy) ---
      - name: Install Syft and Trivy
        run: |
          mkdir -p "$GITHUB_WORKSPACE/bin"
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b "$GITHUB_WORKSPACE/bin"
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b "$GITHUB_WORKSPACE/bin"
          echo "$GITHUB_WORKSPACE/bin" >> $GITHUB_PATH

      # --- 3. Generate SBOM ---
      - name: Generate SBOM
        run: |
          # Use the filename expected in the JSON: dotcms.sbom
          SBOM_PATH="data/sboms/docker.io/dotcms/dotcms/dotcms.sbom"
          mkdir -p "$(dirname "$SBOM_PATH")"
          syft scan dir:. -o syft-table > "$SBOM_PATH"

      # --- 4. Trivy Vulnerability Scan ---
      - name: Run Trivy Scan
        run: |
          trivy fs . \
            --format json \
            --severity CRITICAL,HIGH \
            --output cve-report.json \
            --exit-code 0 \
            --timeout 20m \
            --scanners vuln \
            --skip-dirs "**/src/test,**/node_modules,**/examples,.github/actions" \
            --skip-files "core-web/documentation.json"

      # --- 5. Generate JSON Input File (Matches your provided structure) ---
      - name: Create JSON Input File
        run: |
          cat << 'EOF' > create_input_json.py
          import json
          import os

          INPUT_FILE = os.getenv('INPUT_FILENAME', 'input.json')
          TRIVY_REPORT = 'cve-report.json'

          def extract_cve_ids(report_path):
              cve_ids = set()
              if not os.path.exists(report_path): return []
              with open(report_path, 'r') as f: report = json.load(f)
              for result in report.get('Results', []):
                  for vuln in result.get('Vulnerabilities', []):
                      cve_ids.add(vuln.get('VulnerabilityID'))
              return [{"vuln_id": cid} for cid in sorted(list(cve_ids)) if cid]

          # Full structure based on user requirements
          DATA = {
              "image": {
                  "name": "docker.io/dotcms/dotcms",
                  "tag": "latest",
                  "source_info": [
                      {
                          "type": "code",
                          "git_repo": "https://github.com/dotCMS/core.git",
                          "ref": "main",
                          "include": [
                              "**/pom.xml", "pom.xml", "parent/pom.xml", "build-parent/pom.xml", "bom/pom.xml",
                              "dotCMS/pom.xml", "core-web/pom.xml", "dotcms-integration/pom.xml", 
                              "core/src/main/java/**/*", "core/src/main/resources/**/*", 
                              "dotCMS/src/main/java/**/*", "dotCMS/src/main/resources/**/*", 
                              "dotCMS/WEB-INF/**/*", "dotcms-integration/src/main/java/**/*", 
                              "core-web/src/main/java/**/*", "core-web/src/main/resources/**/*",
                              "environments/*/elasticsearch.yml", "environments/*/opensearch.yml",
                              "docker/*/elasticsearch.yml", "config/elasticsearch.yml", "config/opensearch.yml",
                              "**/tika-config.xml", "**/dotmarketing-config.properties", "**/user.properties",
                              "**/private.xml", "**/security-*.properties", "**/web.xml", "**/src/main/java/**/*",
                              "docker/Dockerfile", "docker-compose.yml", "SECURITY.md", "README.md",
                              "yarn.lock", "package-lock.json", "**/package.json"
                          ],
                          "exclude": [
                              "**/target/**", "**/build/**", "**/node_modules/**", "**/dist/**", 
                              "**/*.min.js", "**/src/test/**", "**/src/integration-test/**", 
                              "**/.git/**", "**/.gradle/**", "**/docs/**"
                          ]
                      },
                      {
                          "type": "doc",
                          "git_repo": "https://github.com/dotCMS/core.git",
                          "ref": "main",
                          "include": ["README.md", "LICENSE", "CHANGELOG.md", "SECURITY.md"]
                      }
                  ],
                  "sbom_info": {
                      "_type": "file",
                      "file_path": "data/sboms/docker.io/dotcms/dotcms/dotcms.sbom"
                  },
                  "dependency_files": ["**/pom.xml", "**/package.json", "yarn.lock", "package-lock.json"],
                  "build_system": "maven"
              },
              "scan": {
                  "vulns": extract_cve_ids(TRIVY_REPORT)
              }
          }
          
          with open(INPUT_FILE, 'w') as f:
              json.dump(DATA, f, indent=2)
          EOF
          python3 create_input_json.py
        env:
          INPUT_FILENAME: ${{ github.event.inputs.input_filename }}

      # --- 6. Stage Files and Run NVIDIA Scanner ---
      - name: Execute NVIDIA Analysis
        run: |
          INPUT_DIR="${{ env.TOOL_PATH }}/data/input_messages"
          SBOM_DEST_DIR="${{ env.TOOL_PATH }}/data/sboms/docker.io/dotcms/dotcms"
          
          mkdir -p "$INPUT_DIR"
          mkdir -p "$SBOM_DEST_DIR"
          
          # Move local artifacts to remote tool folders
          cp "${{ github.workspace }}/${{ github.event.inputs.input_filename }}" "$INPUT_DIR/input.json"
          cp "${{ github.workspace }}/data/sboms/docker.io/dotcms/dotcms/dotcms.sbom" "$SBOM_DEST_DIR/"

          cd ${{ env.TOOL_PATH }}
          
          # Login to NGC
          echo "${{ env.NVIDIA_API_KEY }}" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          
          # Ensure tool is running
          docker compose up -d
          
          # RUN COMMAND AS SPECIFIED:
          docker compose exec -T \
            -e NVIDIA_API_KEY="${{ env.NVIDIA_API_KEY }}" \
            -e GHSA_API_KEY="${{ env.GHSA_API_KEY }}" \
            -e NVD_API_KEY="${{ env.NVD_API_KEY }}" \
            vuln-analysis nat run \
            --config_file="configs/config.yml" \
            --input_file="data/input_messages/input.json"

      # --- 7. Generate Summary and Push to test-copy Repo ---
      - name: Process Results and Push
        env:
          RESULTS_REPO: "https://x-access-token:${{ secrets.MY_PAT }}@github.com/rsh1k/test-copy.git"
        run: |
          sudo chown -R $USER:$USER "$REPORT_DIR"

          cat << 'EOF' > generate_summary.py
          import os
          import json
          import glob
          import datetime

          def generate():
              trivy_file = 'cve-report.json'
              source_dir = os.getenv('REPORT_DIR')
              
              trivy_data = {}
              if os.path.exists(trivy_file):
                  with open(trivy_file) as f:
                      data = json.load(f)
                      for res in data.get('Results', []):
                          for v in res.get('Vulnerabilities', []):
                              trivy_data[v['VulnerabilityID']] = v.get('Severity', 'UNKNOWN')

              report_md = f"# Scan Results: {datetime.datetime.now().strftime('%Y-%m-%d %H:%M')}\n\n"
              report_md += "| CVE ID | Severity | NVIDIA Analysis | Report Link |\n"
              report_md += "| :--- | :--- | :--- | :--- |\n"

              md_files = glob.glob(f"{source_dir}/*.md")
              for filepath in sorted(md_files):
                  filename = os.path.basename(filepath)
                  if filename == "README.md": continue
                  cve_id = filename.replace('.md', '')
                  severity = trivy_data.get(cve_id, "N/A")
                  
                  status = "Pending review"
                  try:
                      with open(filepath, 'r') as f:
                          content = f.read().lower()
                          if "false positive" in content: status = "❌ False Positive"
                          elif "true positive" in content: status = "✅ True Positive"
                  except: pass

                  report_md += f"| {cve_id} | {severity} | {status} | [View File](./{filename}) |\n"

              with open(os.path.join(source_dir, "README.md"), "w") as f:
                  f.write(report_md)

          generate()
          EOF

          python3 generate_summary.py

          RUN_FOLDER="run-${{ github.run_number }}-${{ github.run_id }}"
          git clone $RESULTS_REPO results_repo
          mkdir -p "results_repo/$RUN_FOLDER"
          cp "$REPORT_DIR"/*.md "results_repo/$RUN_FOLDER/"
          
          cd results_repo
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "Reports for run ${{ github.run_number }}"
          git push
