name: Local Self-Hosted Vulnerability Analysis

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  analyze-locally:
    runs-on: self-hosted 

    env:
      SBOM_DIR: "/home/rashik/vulnerability-analysis/data/sboms/docker.io/dotcms/dotcms"
      INPUT_DIR: "/home/rashik/vulnerability-analysis/data/input_messages"
      TOOL_DIR: "/home/rashik/vulnerability-analysis"
      OUTPUT_DIR: "/home/rashik/vulnerability-analysis/output"

    steps:
      - name: Checkout dotCMS Repository
        uses: actions/checkout@v4
        with:
          path: dotcms-repo 

      - name: Cleanup Old Data
        run: |
          echo "Cleaning up previous run data..."
          rm -rf "${{ env.SBOM_DIR }}"/*
          rm -rf "${{ env.INPUT_DIR }}"/*
          mkdir -p "${{ env.OUTPUT_DIR }}"
          rm -rf "${{ env.OUTPUT_DIR }}"/*
          rm -f cve-report.json
          rm -rf target-repo

      - name: Generate Syft SBOM
        run: |
          mkdir -p "${{ env.SBOM_DIR }}"
          syft docker.io/dotcms/dotcms:latest -o syft-table > "${{ env.SBOM_DIR }}/dotcms.sbom"

      - name: Run Trivy Scan
        run: |
          trivy image docker.io/dotcms/dotcms:latest --format json --severity CRITICAL,HIGH --output cve-report.json

      - name: Update input.json with Full File Filters
        shell: python
        run: |
          import json
          import os

          with open('cve-report.json') as f:
              report = json.load(f)
          
          cves = [{"vuln_id": v['VulnerabilityID']} for res in report.get('Results', []) for v in res.get('Vulnerabilities', [])]

          config = {
            "image": {
              "name": "docker.io/dotcms/dotcms",
              "tag": "latest",
              "source_info": [
                {
                  "type": "code",
                  "git_repo": "https://github.com/dotCMS/core.git",
                  "ref": "main",
                  "include": [
                    "**/pom.xml", "pom.xml", "parent/pom.xml", "build-parent/pom.xml", "bom/pom.xml", "dotCMS/pom.xml", "core-web/pom.xml", "dotcms-integration/pom.xml", 
                    "core/src/main/java/**/*", "core/src/main/resources/**/*", "dotCMS/src/main/java/**/*", "dotCMS/src/main/resources/**/*", "dotCMS/WEB-INF/**/*", 
                    "dotcms-integration/src/main/java/**/*", "core-web/src/main/java/**/*", "core-web/src/main/resources/**/*", "environments/*/elasticsearch.yml", 
                    "environments/*/opensearch.yml", "docker/*/elasticsearch.yml", "config/elasticsearch.yml", "config/opensearch.yml", "dotCMS/src/main/resources/tika-config.xml", 
                    "dotCMS/WEB-INF/tika-config.xml", "**/tika-config.xml", "dotCMS/src/main/webapp/WEB-INF/tika-config.xml", "dotCMS/WEB-INF/classes/dotmarketing-config.properties", 
                    "dotCMS/src/main/resources/dotmarketing-config.properties", "dotCMS/WEB-INF/classes/dotcms-config-cluster.properties", "**/dotmarketing-config.properties", 
                    "**/user.properties", "**/private.xml", "dotCMS/WEB-INF/classes/security.properties", "dotCMS/src/main/resources/security.properties", "**/security-*.properties", 
                    "dotCMS/WEB-INF/web.xml", "dotCMS/src/main/webapp/WEB-INF/web.xml", "**/web.xml", "dotCMS/src/main/java/com/dotcms/rest/api/v1/temp/TempFileResource.java", 
                    "dotCMS/src/main/java/com/dotcms/rest/ContentResource.java", "dotCMS/src/main/java/com/dotmarketing/servlets/BinaryFileServlet.java", 
                    "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/**/*.java", "dotCMS/src/main/java/com/dotcms/storage/**/*.java", "dotCMS/src/main/java/com/dotmarketing/util/FileUtil.java", 
                    "dotCMS/src/main/java/com/dotcms/util/SecurityUtils.java", "dotCMS/src/main/java/com/dotmarketing/util/SecurityLogger.java", "dotCMS/src/main/java/com/dotcms/security/**/*.java", 
                    "dotCMS/src/main/java/com/dotmarketing/filters/**/*.java", "dotCMS/src/main/java/**/FileUpload*.java", "dotCMS/src/main/java/**/*Upload*.java", "**/src/main/java/**/*FileItem*.java", 
                    "dotCMS/src/main/java/com/dotcms/tika/**/*.java", "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/BinaryFileHandler.java", 
                    "dotCMS/src/main/java/com/dotmarketing/util/TikaUtils.java", "**/src/main/java/**/*Tika*.java", "**/src/main/java/**/*Parser*.java", 
                    "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ContentletIndexAPI.java", "dotCMS/src/main/java/com/dotmarketing/business/DotIndexer.java", 
                    "dotCMS/src/main/java/**/*Index*.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", 
                    "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/DotRestHighLevelClient.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/**/*.java", 
                    "dotCMS/src/main/java/com/dotmarketing/business/ESIndexAPI.java", "dotCMS/src/main/java/com/dotcms/rest/api/v1/content/ContentResource.java", 
                    "dotCMS/src/main/java/com/dotcms/rest/api/v1/elasticsearch/**/*.java", "dotCMS/src/main/java/com/dotcms/graphql/**/*.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/config/**/*.java", 
                    "dotCMS/src/main/java/com/dotmarketing/business/ESConfigurationFactory.java", "dotCMS/src/main/java/**/*Netty*.java", "dotCMS/src/main/resources/netty-config.xml", "**/netty*.properties", 
                    "dotCMS/src/main/java/com/dotmarketing/filters/**/*.java", "dotCMS/src/main/java/com/dotcms/filters/**/*.java", "dotCMS/WEB-INF/classes/filters.xml", 
                    "dotCMS/src/main/java/com/dotcms/filters/CorsFilter.java", "dotCMS/src/main/java/com/dotcms/filters/SecurityHeadersFilter.java", "dotCMS/src/main/java/com/dotmarketing/filters/CMSFilter.java", 
                    "dotCMS/src/main/java/com/dotcms/auth/**/*.java", "dotCMS/src/main/java/com/dotmarketing/filters/LoginRequiredFilter.java", "dotCMS/src/main/java/com/dotcms/rest/WebResource.java", 
                    "dotCMS/src/main/java/com/dotcms/rest/api/v1/authentication/**/*.java", "dotCMS/src/main/java/com/dotmarketing/business/PermissionAPI.java", 
                    "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPI.java", "dotCMS/src/main/java/com/dotcms/security/**/*.java", "dotCMS/src/main/java/com/dotcms/rest/api/v1/apikey/**/*.java", 
                    "dotCMS/src/main/java/com/dotcms/auth/providers/**/*.java", "dotCMS/src/main/java/com/dotcms/security/PasswordDigest.java", "dotCMS/src/main/java/com/dotmarketing/util/SecurityUtils.java", 
                    "dotCMS/src/main/java/**/*Password*.java", "dotCMS/src/main/java/**/*Crypto*.java", "dotCMS/src/main/java/com/dotmarketing/util/CryptUtils.java", 
                    "dotCMS/src/main/java/com/dotcms/util/EncryptionUtil.java", "**/src/main/java/**/*Encrypt*.java", "**/src/main/java/**/*Cipher*.java", "dotCMS/src/main/java/com/dotcms/graphql/**/*.java", 
                    "core-web/src/main/java/com/dotcms/graphql/**/*.java", "**/graphql/**/*.java", "docker/Dockerfile", "docker/*/Dockerfile", "docker-compose.yml", "docker/docker-compose*.yml", 
                    "environments/*/Dockerfile", "docker/*.env", "docker/*/config/**", "environments/*/.env", ".env.example", "owasp-suppressions.xml", ".github/workflows/*.yml", 
                    "cicd/**/*.yml", "cicd/**/*.sh", ".github/dependabot.yml", "renovate.json", ".snyk", "dotCMS/src/test/java/**/*Security*.java", "dotCMS/src/test/java/**/*Permission*.java", 
                    "dotcms-integration/src/test/java/**/*Security*.java", "dotcms-integration/src/test/java/**/*Auth*.java", "**/src/test/java/**/*FileUpload*.java", "**/src/test/java/**/*Upload*.java", 
                    "**/src/test/java/**/*File*Test.java", "SECURITY.md", "docs/security/**/*.md", "docs/**/*security*.md", "README.md", "docs/examples/**/*.properties", "docs/configuration/**/*.yml", 
                    "examples/**/*config*.xml", "dotCMS/src/main/java/com/dotmarketing/util/ValidationUtils.java", "dotCMS/src/main/java/com/dotcms/util/ConversionUtils.py", 
                    "dotCMS/src/main/java/**/*Validator*.java", "dotCMS/src/main/java/**/*Sanitizer*.java", "dotCMS/src/main/java/com/dotcms/rendering/velocity/util/XSS*.java", 
                    "dotCMS/src/main/java/**/*XSS*.java", "dotCMS/src/main/java/com/dotmarketing/util/SecurityLogger.java", "config/user/logging/log4j2.xml", "dotCMS/WEB-INF/classes/log4j2.xml", 
                    "**/log4j2*.xml", "dotCMS/src/main/java/com/dotcms/audit/**/*.java", "dotCMS/src/main/java/com/dotmarketing/business/AuditableAPI.java", "yarn.lock", "package-lock.json", "**/package.json"
                  ],
                  "exclude": [
                    "**/target/**", "**/build/**", "**/node_modules/**", "**/dist/**", "**/*.min.js", "**/src/test/**", "**/src/integration-test/**", "**/.git/**", "**/.gradle/**", "**/docs/**"
                  ]
                },
                {
                  "type": "doc",
                  "git_repo": "https://github.com/dotCMS/core.git",
                  "ref": "main",
                  "include": ["README.md", "LICENSE", "CHANGELOG.md", "SECURITY.md"]
                }
              ],
              "sbom_info": {
                "_type": "file",
                "file_path": "data/sboms/docker.io/dotcms/dotcms/dotcms.sbom"
              },
              "dependency_files": ["**/pom.xml", "**/package.json", "yarn.lock", "package-lock.json"],
              "build_system": "maven"
            },
            "scan": { "vulns": cves }
          }

          os.makedirs("${{ env.INPUT_DIR }}", exist_ok=True)
          with open(os.path.join("${{ env.INPUT_DIR }}", "input.json"), 'w') as f:
              json.dump(config, f, indent=2)

      - name: Start Services and Execute NVIDIA AI Analysis
        working-directory: ${{ env.TOOL_DIR }}
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          GHSA_API_KEY: ${{ secrets.GHSA_API_KEY }}
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          SERPAPI_API_KEY: ${{ secrets.SERPAPI_API_KEY }}
        run: |
          echo "$NVIDIA_API_KEY" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          docker compose up -d
          sleep 15
          docker compose exec -T vuln-analysis nat run \
            --config_file=configs/config.yml \
            --input_file=data/input_messages/input.json

      - name: Generate Summary Table for GitHub
        shell: python
        run: |
          import os
          import json

          output_dir = "${{ env.OUTPUT_DIR }}"
          summary_file = os.path.join(output_dir, "README.md")
          
          markdown = "# Vulnerability Analysis Report\n\n"
          markdown += "| CVE ID | Severity | AI Finding | Detailed Report |\n"
          markdown += "| :--- | :--- | :--- | :--- |\n"

          files = [f for f in os.listdir(output_dir) if f.endswith(('.json', '.md')) and f not in ["README.md", "input.json"]]
          
          for file in sorted(files):
              cve_id = file.split('.')[0]
              severity = "CRITICAL/HIGH"
              status = "Analyzed"
              markdown += f"| **{cve_id}** | {severity} | {status} | [View Details](./{file}) |\n"

          with open(summary_file, "w") as f:
              f.write(markdown)

      # --- REPLACED GIT PUSH LOGIC ---
      - name: Checkout Target Repository
        uses: actions/checkout@v4
        with:
          repository: rsh1k/test-copy
          token: ${{ secrets.PAT_TOKEN }}
          path: target-repo
          ref: master

      - name: Update Reports and Push
        run: |
          cd target-repo
          # Clear old reports and copy new ones
          mkdir -p reports
          rm -rf reports/*
          cp -r ${{ env.OUTPUT_DIR }}/* reports/
          
          # Git Config (Local to this repo)
          git config user.name "Vulnerability Bot"
          git config user.email "bot@github.com"
          
          # Add, Commit, and Push
          git add reports/
          if git diff --staged --quiet; then
            echo "No changes found."
          else
            git commit -m "Security Scan Update: $(date +'%Y-%m-%d %H:%M')"
            git push origin master
          fi
