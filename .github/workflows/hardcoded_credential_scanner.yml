name: Credential Scan with credential-detector

on:
  release:
    types: [published] # Trigger when a release is published
  workflow_dispatch: # Allow manual triggering

jobs:
  scan-credentials:
    name: Scan dotCMS Core for Credentials
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repository
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Fetch all history to ensure full repository scan

      # Step 2: Set up Go environment
      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21' # Specify a stable Go version (adjust as needed)

      # Step 3: Install credential-detector
      - name: Install credential-detector
        run: go install github.com/ynori7/credential-detector@latest

      # Step 4: Create configuration file (optional, customize as needed)
      - name: Create credential-detector config
        run: |
          cat << 'EOF' > config.yaml
          variableNamePatterns:
            - (?i)passwd|password
            - (?i)secret
            - (?i)token
            - (?i)apiKey|api[_-]key
          variableNameExclusionPattern: (?i)format|tokenizer|secretName
          xmlAttributeNameExclusionPattern: (?i)token
          valueMatchPatterns:
            - name: Postgres URI
              pattern: postgres:\/\/.+:.+@.+:.+\/.+
            - name: JWT Token
              pattern: eyJhbGciOiJIUzI1NiIsInR5cCI[a-zA-Z0-9_.]+
          variableValueExcludePatterns:
            - (?i)^test$|password|^postgres$|^root$|^foobar$|^example$|^changeme$|^default$|^master$
          fullTextValueExcludePatterns:
            - postgres:\/\/.+:.+@localhost:.+\/.+
            - postgres:\/\/.+:.+@127.0.0.1:.+\/.+
            - postgres:\/\/postgres:postgres@postgres:.+\/.+
          minPasswordLength: 6
          excludeTests: true
          testDirectories:
            - test
          ignoreFiles:
            - vendor
          excludeComments: false
          scanTypes:
            - go
            - yaml
            - json
            - properties
            - privatekey
            - xml
            - php
            - bash
            - generic
            - generic_code
          genericFileExtensions:
            - txt
            - md
            - html
          genericCodeFileExtensions:
            - java
            - swift
            - cpp
          disableOutputColors: false
          verbose: true
          EOF

      # Step 5: Run credential-detector scan
      - name: Run credential-detector
        run: |
          ~/go/bin/credential-detector --config config.yaml --path .
        env:
          GOROOT: ${{ env.GOROOT }}

      # Step 6: Upload scan results as artifact (optional)
      - name: Upload scan results
        if: always() # Upload even if scan fails to capture output
        uses: actions/upload-artifact@v4
        with:
          name: credential-scan-results
          path: |
            config.yaml
            *.log # Assuming credential-detector outputs logs
