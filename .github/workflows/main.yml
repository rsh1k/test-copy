name: Security Automation: Syft SBOM & Custom JSON Update

on:
  push:
    branches: [ main, master ]
  workflow_dispatch:

jobs:
  syft-trivy-scan-and-update:
    runs-on: ubuntu-latest
    permissions:
      contents: write # Required to commit the updated files

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # --- 1. Install Syft and Trivy ---
      - name: Install Syft and Trivy
        run: |
          curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin
          curl -sfL https://raw.githubusercontent.com/aquasecurity/trivy/main/contrib/install.sh | sh -s -- -b /usr/local/bin

      # --- 2. Syft SBOM Generation (Table Format) ---
      - name: Generate SBOM in Table Format using Syft
        run: |
          # Define the exact required path for the SBOM file
          SBOM_PATH="data/sboms/docker.io/dotcms/dotcms/dotcms:latest.sbom"
          
          # Ensure the directory exists
          mkdir -p "$(dirname $SBOM_PATH)"
          
          # Generate the table-formatted SBOM directly into the target path
          echo "Generating SBOM to $SBOM_PATH"
          syft fs . -o syft-table > $SBOM_PATH
          echo "SBOM generation complete."

      # --- 3. Trivy Vulnerability (CVE) Scanning ---
      - name: Run Vulnerability Scan (CVEs) using Trivy
        run: |
          # Scan the filesystem and output High/Critical CVEs as JSON
          trivy fs . \
            --format json \
            --severity CRITICAL,HIGH \
            --output cve-report.json \
            --exit-code 0 # Do not fail the CI on finding vulnerabilities

      # --- 4. Process and Update JSON Input File ---
      - name: Install Python and Process JSON Input
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Execute CVE Parsing and JSON Update
        # This script maintains the original JSON structure but updates the vulns list.
        run: |
          cat << EOF > update_json_input.py
          import json
          import os

          # --- Configuration ---
          TRIVY_REPORT = 'cve-report.json'
          INPUT_FILE = 'input_analysis_config.json' # The target file for the NVIDIA tool
          
          # Define the base structure provided by the user
          BASE_JSON = {
            "image": {
              "name": "docker.io/dotcms/dotcms",
              "tag": "latest",
              "source_info": [
                # ... (rest of the source_info omitted for brevity, but contained in the script)
                {
                    "type": "code",
                    "git_repo": "https://github.com/dotCMS/core.git",
                    "ref": "main",
                    "include": [
                        "**/pom.xml", "pom.xml", "parent/pom.xml", "build-parent/pom.xml", "bom/pom.xml", "dotCMS/pom.xml", "core-web/pom.xml", "dotcms-integration/pom.xml", "core/src/main/java/**/*", "core/src/main/resources/**/*", "dotCMS/src/main/java/**/*", "dotCMS/src/main/resources/**/*", "dotCMS/WEB-INF/**/*", "dotcms-integration/src/main/java/**/*", "core-web/src/main/java/**/*", "core-web/src/main/resources/**/*", "environments/*/elasticsearch.yml", "environments/*/opensearch.yml", "docker/*/elasticsearch.yml", "config/elasticsearch.yml", "config/opensearch.yml", "dotCMS/src/main/resources/tika-config.xml", "dotCMS/WEB-INF/tika-config.xml", "**/tika-config.xml", "dotCMS/src/main/webapp/WEB-INF/tika-config.xml", "dotCMS/WEB-INF/classes/dotmarketing-config.properties", "dotCMS/src/main/resources/dotmarketing-config.properties", "dotCMS/WEB-INF/classes/dotcms-config-cluster.properties", "**/dotmarketing-config.properties", "**/user.properties", "**/private.xml", "dotCMS/WEB-INF/classes/security.properties", "dotCMS/src/main/resources/security.properties", "**/security-*.properties", "dotCMS/WEB-INF/web.xml", "dotCMS/src/main/webapp/WEB-INF/web.xml", "**/web.xml", "dotCMS/src/main/java/com/dotcms/rest/api/v1/temp/TempFileResource.java", "dotCMS/src/main/java/com/dotcms/rest/ContentResource.java", "dotCMS/src/main/java/com/dotmarketing/servlets/BinaryFileServlet.java", "dotCMS/src/main/java/com/dotmarketing/portlets/fileassets/**/*.java", "dotCMS/src/main/java/com/dotcms/storage/**/*.java", "dotCMS/src/main/java/com/dotmarketing/util/FileUtil.java", "dotCMS/src/main/java/com/dotcms/util/SecurityUtils.java", "dotCMS/src/main/java/com/dotmarketing/util/SecurityLogger.java", "dotCMS/src/main/java/com/dotcms/security/**/*.java", "dotCMS/src/main/java/com/dotmarketing/filters/**/*.java", "dotCMS/src/main/java/**/FileUpload*.java", "dotCMS/src/main/java/**/*Upload*.java", "**/src/main/java/**/*FileItem*.java", "dotCMS/src/main/java/com/dotcms/tika/**/*.java", "dotCMS/src/main/java/com/dotmarketing/portlets/contentlet/business/BinaryFileHandler.java", "dotCMS/src/main/java/com/dotmarketing/util/TikaUtils.java", "**/src/main/java/**/*Tika*.java", "**/src/main/java/**/*Parser*.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ContentletIndexAPI.java", "dotCMS/src/main/java/com/dotmarketing/business/DotIndexer.java", "dotCMS/src/main/java/**/*Index*.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/ESContentletAPIImpl.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/business/DotRestHighLevelClient.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/**/*.java", "dotCMS/src/main/java/com/dotmarketing/business/ESIndexAPI.java", "dotCMS/src/main/java/com/dotcms/rest/api/v1/content/ContentResource.java", "dotCMS/src/main/java/com/dotcms/rest/api/v1/elasticsearch/**/*.java", "dotCMS/src/main/java/com/dotcms/graphql/**/*.java", "dotCMS/src/main/java/com/dotcms/content/elasticsearch/config/**/*.java", "dotCMS/src/main/java/com/dotmarketing/business/ESConfigurationFactory.java", "dotCMS/src/main/java/**/*Netty*.java", "dotCMS/src/main/resources/netty-config.xml", "**/netty*.properties", "dotCMS/src/main/java/com/dotmarketing/filters/**/*.java", "dotCMS/src/main/java/com/dotcms/filters/**/*.java", "dotCMS/WEB-INF/classes/filters.xml", "dotCMS/src/main/java/com/dotcms/filters/CorsFilter.java", "dotCMS/src/main/java/com/dotcms/filters/SecurityHeadersFilter.java", "dotCMS/src/main/java/com/dotmarketing/filters/CMSFilter.java", "dotCMS/src/main/java/com/dotcms/auth/**/*.java", "dotCMS/src/main/java/com/dotmarketing/filters/LoginRequiredFilter.java", "dotCMS/src/main/java/com/dotcms/rest/WebResource.java", "dotCMS/src/main/java/com/dotcms/rest/api/v1/authentication/**/*.java", "dotCMS/src/main/java/com/dotmarketing/business/PermissionAPI.java", "dotCMS/src/main/java/com/dotmarketing/business/PermissionBitAPI.java", "dotCMS/src/main/java/com/dotcms/security/**/*.java", "dotCMS/src/main/java/com/dotcms/rest/api/v1/apikey/**/*.java", "dotCMS/src/main/java/com/dotcms/auth/providers/**/*.java", "dotCMS/src/main/java/com/dotcms/security/PasswordDigest.java", "dotCMS/src/main/java/com/dotmarketing/util/SecurityUtils.java", "dotCMS/src/main/java/**/*Password*.java", "dotCMS/src/main/java/**/*Crypto*.java", "dotCMS/src/main/java/com/dotmarketing/util/CryptUtils.java", "dotCMS/src/main/java/com/dotcms/util/EncryptionUtil.java", "**/src/main/java/**/*Encrypt*.java", "**/src/main/java/**/*Cipher*.java", "dotCMS/src/main/java/com/dotcms/graphql/**/*.java", "core-web/src/main/java/com/dotcms/graphql/**/*.java", "**/graphql/**/*.java", "docker/Dockerfile", "docker/*/Dockerfile", "docker-compose.yml", "docker/docker-compose*.yml", "environments/*/Dockerfile", "docker/*.env", "docker/*/config/**", "environments/*/.env", ".env.example", "owasp-suppressions.xml", ".github/workflows/*.yml", "cicd/**/*.yml", "cicd/**/*.sh", ".github/dependabot.yml", "renovate.json", ".snyk", "dotCMS/src/test/java/**/*Security*.java", "dotCMS/src/test/java/**/*Permission*.java", "dotcms-integration/src/test/java/**/*Security*.java", "dotcms-integration/src/test/java/**/*Auth*.java", "**/src/test/java/**/*FileUpload*.java", "**/src/test/java/**/*Upload*.java", "**/src/test/java/**/*File*Test.java", "SECURITY.md", "docs/security/**/*.md", "docs/**/*security*.md", "README.md", "docs/examples/**/*.properties", "docs/configuration/**/*.yml", "examples/**/*config*.xml", "dotCMS/src/main/java/com/dotmarketing/util/ValidationUtils.java", "dotCMS/src/main/java/com/dotcms/util/ConversionUtils.java", "dotCMS/src/main/java/**/*Validator*.java", "dotCMS/src/main/java/**/*Sanitizer*.java", "dotCMS/src/main/java/com/dotcms/rendering/velocity/util/XSS*.java", "dotCMS/src/main/java/**/*XSS*.java", "dotCMS/src/main/java/com/dotmarketing/util/SecurityLogger.java", "config/user/logging/log4j2.xml", "dotCMS/WEB-INF/classes/log4j2.xml", "**/log4j2*.xml", "dotCMS/src/main/java/com/dotcms/audit/**/*.java", "dotCMS/src/main/java/com/dotmarketing/business/AuditableAPI.java", "yarn.lock", "package-lock.json", "**/package.json"
                    ],
                    "exclude": [
                        "**/target/**", "**/build/**", "**/node_modules/**", "**/dist/**", "**/*.min.js", "**/src/test/**", "**/src/integration-test/**", "**/.git/**", "**/.gradle/**", "**/docs/**"
                    ]
                },
                {
                    "type": "doc",
                    "git_repo": "https://github.com/dotCMS/core.git",
                    "ref": "main",
                    "include": ["README.md", "LICENSE", "CHANGELOG.md", "SECURITY.md"]
                }
              ],
              "sbom_info": {
                "_type": "file",
                "file_path": "data/sboms/docker.io/dotcms/dotcms/dotcms:latest.sbom"
              },
              "dependency_files": [
                "**/pom.xml",
                "**/package.json",
                "yarn.lock",
                "package-lock.json"
              ],
              "build_system": "maven"
            },
            "scan": {
              "vulns": [] # This will be populated by the script
            }
          }
          # --- End Base JSON ---


          def extract_cve_ids(report_path):
              """Parses the Trivy JSON report and extracts unique CVE IDs."""
              cve_ids = set()
              try:
                  with open(report_path, 'r') as f:
                      report = json.load(f)
              except FileNotFoundError:
                  print(f"Report file not found at {report_path}. No CVEs to process.")
                  return []

              for result in report.get('Results', []):
                  if 'Vulnerabilities' in result:
                      for vuln in result['Vulnerabilities']:
                          cve_ids.add(vuln.get('VulnerabilityID'))
                          
              # Convert unique IDs to the required JSON list format
              return [{"vuln_id": cve_id} for cve_id in sorted(list(cve_ids)) if cve_id]

          # --- Main execution ---
          new_vulns_list = extract_cve_ids(TRIVY_REPORT)
          
          # Update the BASE_JSON structure with the new list of CVEs
          BASE_JSON['scan']['vulns'] = new_vulns_list
          
          # Write the updated JSON to the input file
          with open(INPUT_FILE, 'w') as f:
              # Use indent=2 for human readability and consistency
              json.dump(BASE_JSON, f, indent=2)
              
          print(f"Successfully updated {INPUT_FILE} with {len(new_vulns_list)} unique CVEs.")
          
          EOF
          python update_json_input.py

      # --- 5. Commit and Push Changes ---
      - name: Check for File Changes
        id: git_status
        run: |
          SBOM_PATH="data/sboms/docker.io/dotcms/dotcms/dotcms:latest.sbom"
          INPUT_FILE='input_analysis_config.json'

          # Check if either the SBOM or the JSON input file has changed
          if git diff --exit-code --quiet $SBOM_PATH $INPUT_FILE; then
            echo "changes_detected=false" >> $GITHUB_OUTPUT
          else
            echo "changes_detected=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit Updated Files
        if: steps.git_status.outputs.changes_detected == 'true'
        run: |
          SBOM_PATH="data/sboms/docker.io/dotcms/dotcms/dotcms:latest.sbom"
          INPUT_FILE='input_analysis_config.json'

          git config user.name github-actions[bot]
          git config user.email 41898282+github-actions[bot]@users.noreply.github.com
          git add $SBOM_PATH $INPUT_FILE
          git commit -m "ðŸ¤– SEC: Automated update of Syft SBOM and vulnerability config [skip ci]"
          git push
