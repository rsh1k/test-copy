name: Local Self-Hosted Vulnerability Analysis

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  analyze-locally:
    runs-on: self-hosted 

    env:
      # Absolute paths on your local machine
      SBOM_DIR: "/home/rashik/vulnerability-analysis/data/sboms/docker.io/dotcms/dotcms"
      INPUT_DIR: "/home/rashik/vulnerability-analysis/data/input_messages"
      TOOL_DIR: "/home/rashik/vulnerability-analysis"

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          path: dotcms-repo 

      # --- 1. Generate Table SBOM from Container Image ---
      - name: Generate Syft SBOM
        run: |
          mkdir -p "${{ env.SBOM_DIR }}"
          echo "Pulling and Scanning dotCMS Image with Syft..."
          # Scan the image directly. Redirection (>) handles the file output.
          syft docker.io/dotcms/dotcms:latest -o syft-table > "${{ env.SBOM_DIR }}/dotcms.sbom"
          echo "SBOM saved successfully to ${{ env.SBOM_DIR }}/dotcms.sbom"

      # --- 2. Generate Trivy CVE Report ---
      - name: Run Trivy Scan
        run: |
          echo "Scanning for High/Critical vulnerabilities..."
          # We scan the image with Trivy as well for consistency with the SBOM
          trivy image docker.io/dotcms/dotcms:latest --format json --severity CRITICAL,HIGH --output cve-report.json

      # --- 3. Update input.json ---
      - name: Update input.json
        shell: python
        run: |
          import json
          import os

          # Read Trivy results
          with open('cve-report.json') as f:
              report = json.load(f)
          
          cves = []
          # Extract unique Vulnerability IDs
          for res in report.get('Results', []):
              if 'Vulnerabilities' in res:
                  for v in res['Vulnerabilities']:
                      cves.append({"vuln_id": v['VulnerabilityID']})

          # Construct the specific NVIDIA Blueprint config
          config = {
            "image": {
              "name": "docker.io/dotcms/dotcms",
              "tag": "latest",
              "source_info": [
                {
                  "type": "code",
                  "git_repo": "https://github.com/dotCMS/core.git",
                  "ref": "main",
                  "include": ["**/*"],
                  "exclude": ["**/target/**"]
                }
              ],
              "sbom_info": {
                "_type": "file",
                "file_path": "data/sboms/docker.io/dotcms/dotcms/dotcms.sbom"
              },
              "dependency_files": ["**/pom.xml", "package.json"],
              "build_system": "maven"
            },
            "scan": { "vulns": cves }
          }

          input_file_path = os.path.join("${{ env.INPUT_DIR }}", "input.json")
          with open(input_file_path, 'w') as f:
              json.dump(config, f, indent=2)
          print(f"Updated {input_file_path} with {len(cves)} CVEs.")

      # --- 4. Run NVIDIA Analysis Tool ---
      - name: Run NVIDIA Analysis
        working-directory: ${{ env.TOOL_DIR }}
        env:
          NVIDIA_API_KEY: ${{ secrets.NVIDIA_API_KEY }}
          GHSA_API_KEY: ${{ secrets.GHSA_API_KEY }}
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          SERPAPI_API_KEY: ${{ secrets.SERPAPI_API_KEY }}
        run: |
          # Registry login for NGC
          echo "$NVIDIA_API_KEY" | docker login nvcr.io -u '$oauthtoken' --password-stdin
          
          # Execute the NVIDIA blueprint tool using docker-compose
          # The tool maps its local 'data' folder to the internal container path.
          docker compose run --rm \
            -e NVIDIA_API_KEY=$NVIDIA_API_KEY \
            -e GHSA_API_KEY=$GHSA_API_KEY \
            -e NVD_API_KEY=$NVD_API_KEY \
            -e SERPAPI_API_KEY=$SERPAPI_API_KEY \
            vuln-analysis nat run --config data/input_messages/input.json

      # --- 5. Upload Results to GitHub UI ---
      - name: Upload Results
        uses: actions/upload-artifact@v4
        with:
          name: dotcms-vulnerability-report
          path: ${{ env.TOOL_DIR }}/output/
